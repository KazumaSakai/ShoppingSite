package com.internousdev.ShoppingSite.oauth;

import java.awt.Desktop;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintStream;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.net.URLConnection;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.internousdev.ShoppingSite.util.Passworder;

public class GoogleOAuth {
	private static final String client_id = "34746352072-tv6neqgl7uhuqutiqm5e93e4sbhn43li.apps.googleusercontent.com";
	private static final String client_secret = "_H9AFED1Qxt4rcgYCgHaLtEp ";
	
	public static String UserInfo(GoogleOAuthToken token)
	{
		Desktop desktop = Desktop.getDesktop();
		String URL = "https://www.googleapis.com/oauth2/v1/userinfo?"
				+ "access_token=" + token.access_token;
		try
		{
			URI uri = new URI(URL);
			desktop.browse(uri);
			ActionFoward ac
		}
		catch (Exception e)
		{
			e.fillInStackTrace();
		}
	}
	
	public static GoogleOAuthToken token(String code)
	{
		String callBackURL = "http://localhost:8080/ShoppingSite/GoogleOauthAction.action";
		
		String tokenURL = "https://accounts.google.com/o/oauth2/token?"
				+ "code=" + code
				+ "&grant_type=authorization_code"
				+ "&redirect_uri=" + callBackURL
				+ "&client_id=" + client_id
				+ "&client_secret=" + client_secret;

		GoogleOAuthToken googleOAuthToken = null;
		try
		{
			googleOAuthToken = new ObjectMapper().readValue(Post(tokenURL), GoogleOAuthToken.class);
        }
		catch (IOException e)
		{
            e.printStackTrace();
        }
		
		return googleOAuthToken;
	}
	
	public static String Post(String urlString)
	{
        String line = "";
        try {
            URL url = new URL(urlString);
            URLConnection uc = url.openConnection();
            uc.setDoOutput(true);//POST可能にする
 
            uc.setRequestProperty("User-Agent", "@IT java-tips URLConnection");// ヘッダを設定
            uc.setRequestProperty("Accept-Language", "ja");// ヘッダを設定
            OutputStream os = uc.getOutputStream();//POST用のOutputStreamを取得
        
            String postStr = "foo1=bar1&foo2=bar2";//POSTするデータ
            PrintStream ps = new PrintStream(os);
            ps.print(postStr);//データをPOSTする
            ps.close();
 
            InputStream is = uc.getInputStream();//POSTした結果を取得
            BufferedReader reader = new BufferedReader(new InputStreamReader(is));
            String s;
            while ((s = reader.readLine()) != null)
            {
            	line += s + "\n";
            }
            reader.close();
        } catch (MalformedURLException e) {
            System.err.println("Invalid URL format: " + urlString);
            System.exit(-1);
        } catch (IOException e) {
            System.err.println("Can't connect to " + urlString);
            System.exit(-1);
        }
        
        return line;
	}
	
	public static String login()
	{
		String redirect_uri = "http://localhost:8080/ShoppingSite/GoogleOauthAction.action";
		try
		{
			Desktop desktop = Desktop.getDesktop();
			try
			{
				URI uri = new URI("https://accounts.google.com/o/oauth2/auth?client_id=" + client_id
						+ "&redirect_uri=" + redirect_uri
						+ "&scope=https://www.googleapis.com/auth/userinfo.profile"
						+ "&response_type=code"
						+ "&access_type=offline"
						+ "&approval_prompt=force"
						+ "&state=" + Passworder.Random());
				
				desktop.browse(uri);
			}
			catch (URISyntaxException e)
			{
				e.printStackTrace();
			}
			catch (IOException e)
			{
				e.printStackTrace();
			}
		}
		catch (Exception e) 
		{
			e.printStackTrace();
		}
		
		return null;
	}
}
